<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - Karla Priscilia Confeitaria</title>
    <!-- Estilos do painel de administração -->
    <link rel="stylesheet" href="../static/Style/Style_admin.css">
    <!-- Ícones Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Transição barra de filtros */
        #filterBar{
            max-height:0;
            opacity:0;
            overflow:hidden;
            display:flex;
            transition:max-height 0.35s ease, opacity 0.35s ease, padding 0.35s ease;
        }
        #filterBar.open{
            max-height:300px; /* valor alto suficiente */
            opacity:1;
            padding:0.75rem 1.5rem;
        }
    </style>
</head>
<body>

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="admin-brand">
                <h2>Karla Priscilia</h2>
                <p>Confeitaria</p>
            </div>
            <nav class="admin-nav">
                <ul>
                    <li><a href="{{ url_for('admin_dashboard') }}"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
                    <li><a href="{{ url_for('admin_cardapio') }}"><i class="fas fa-book-open"></i> Cardápio</a></li>
                    <li><a href="{{ url_for('admin_pedidos') }}" class="active"><i class="fas fa-receipt"></i> Pedidos</a></li>
                    <li><a href="{{ url_for('logout') }}" class="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-content">
            <header class="admin-header pedidos-header">
                <h1>Pedidos</h1>
            </header>
            
            <section class="calendar-container">
                <!-- Calendário será inserido dinamicamente aqui -->
            </section>

            <section class="pedidos-table-container">
                <div class="pedidos-table-header">
                    <h4>Lista de Pedidos</h4>
                </div>
                <!-- Filtro de pesquisa -->
                <button id="toggleFilterBtn" class="btn btn-secondary" style="width:auto;margin:0 1.5rem 0.75rem 1.5rem;">Mostrar filtros</button>
                <div id="filterBar" class="filter-bar" style="gap:0.5rem;flex-wrap:wrap;align-items:center;">
                    <input type="date" id="filterDate" title="Data de emissão"/>
                    <select id="filterStatus" title="Status">
                        <option value="">Todos Status</option>
                        <option>Pendente</option>
                        <option>Confirmado</option>
                        <option>Preparando</option>
                        <option>Pronto</option>
                        <option>Entregue</option>
                        <option>Cancelado</option>
                    </select>
                    <input type="number" id="priceMin" placeholder="Preço mín" style="width:100px;"/>
                    <input type="number" id="priceMax" placeholder="Preço máx" style="width:100px;"/>
                    <input type="text" id="filterClient" placeholder="Cliente" style="width:140px;"/>
                    <input type="text" id="filterOrder" placeholder="Nº Pedido" style="width:100px;"/>
                    <button id="clearFilter" class="btn btn-secondary" style="width:auto;">Limpar</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Nº do Pedido</th>
                            <th>Cliente</th>
                            <th>Itens</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Horário</th>
                            <th>Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="ordersBody">
                    {% for p in pedidos %}
                        <tr data-entrega="{{ p.entrega }}" data-pedido="{{ p.criado_em.strftime('%Y-%m-%d') if p.criado_em else '' }}" data-pronto="{{ p.criado_em.strftime('%Y-%m-%d') if p.criado_em else '' }}" data-phone="{{ p.telefone or '' }}">
                            <td>#{{ p.id }}</td>
                            <td>{{ p.cliente }}</td>
                            <td>{{ p.itens_str }}</td>
                            <td>R$ {{ '%.2f'|format(p.total) }}</td>
                            <td class="status">{{ p.status or 'Pendente' }}</td>
                            <td>{{ p.criado_em.strftime('%H:%M') if p.criado_em else '' }}</td>
                            <td><a href="#" class="view-order"><i class="fas fa-chevron-right"></i></a></td>
                        </tr>
                    {% else %}
                        <tr><td colspan="7" style="text-align:center;color:#888;">Nenhum pedido registrado.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </section>

            <!-- Modal Detalhes do Pedido -->
            <div id="orderModal" class="modal">
                <div class="modal-content">
                    <h3>Detalhes do Pedido</h3>
                    <div id="orderInfo" style="margin-top:0.5rem;line-height:1.4;"></div>

                    <label for="orderStatusSelect" style="display:block;margin-top:1rem;">Status</label>
                    <select id="orderStatusSelect" style="width:100%;margin-top:0.25rem;">
                        <option>Pendente</option>
                        <option>Confirmado</option>
                        <option>Preparando</option>
                        <option>Pronto</option>
                        <option>Entregue</option>
                        <option>Cancelado</option>
                    </select>

                    <div class="modal-actions" style="display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem;">
                        <button id="saveOrderBtn" class="btn btn-secondary" style="width:auto;">Salvar</button>
                        <button type="button" id="closeOrderModal" class="btn btn-secondary" style="width:auto;">Fechar</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const orderTbody = document.getElementById('ordersBody');

        // Adiciona botão de visualização em cada linha que ainda não possua
        orderTbody.querySelectorAll('tr').forEach(row=>{
            if(!row.querySelector('.view-order')){
                const td = document.createElement('td');
                td.innerHTML = '<a href="#" class="view-order"><i class="fas fa-chevron-right"></i></a>';
                row.appendChild(td);
            }
        });

        const orderModal = document.getElementById('orderModal');
        // ---- Elementos de filtro ----
        const filterDate   = document.getElementById('filterDate');
        const filterStatus = document.getElementById('filterStatus');
        const priceMin     = document.getElementById('priceMin');
        const priceMax     = document.getElementById('priceMax');
        const filterClient = document.getElementById('filterClient');
        const filterOrder  = document.getElementById('filterOrder');
        const clearFilter  = document.getElementById('clearFilter');
        // ---- Toggle Filtros ----
        const filterBar = document.getElementById('filterBar');
        const toggleFilterBtn = document.getElementById('toggleFilterBtn');
        toggleFilterBtn.addEventListener('click', ()=>{
            filterBar.classList.toggle('open');
            toggleFilterBtn.textContent = filterBar.classList.contains('open') ? 'Ocultar filtros' : 'Mostrar filtros';
        });
        const orderInfo  = document.getElementById('orderInfo');
        const orderStatusSelect = document.getElementById('orderStatusSelect');
        const closeOrderModalBtn = document.getElementById('closeOrderModal');
        const saveOrderBtn = document.getElementById('saveOrderBtn');
        let currentOrderRow = null;

        // === Busca pedidos via API e preenche tabela ===
        async function fetchOrders(){
            try{
                const resp = await fetch('/api/pedidos', {credentials:'same-origin'});
                if(!resp.ok) {console.error('Falha API pedidos', resp.status); return;}
                const lista = await resp.json();
                renderOrders(lista);
            }catch(e){ console.error('Erro fetchOrders', e); }
        }
        function renderOrders(lista){
            orderTbody.innerHTML = '';
            lista.forEach(r=>{
                const tr = document.createElement('tr');
                tr.dataset.entrega = r.entrega || ''; 
                tr.dataset.phone   = r.telefone || '';
                tr.dataset.pronto  = (r.criado_em||'').split('T')[0];
                tr.dataset.pedido  = (r.criado_em||'').split('T')[0];
                const hora = (r.criado_em||'').split('T')[1]?.substring(0,5) || '';
                tr.innerHTML = `
                    <td>#${r.id}</td>
                    <td>${r.cliente||'-'}</td>
                    <td>${r.itens_str||''}</td>
                    <td>R$ ${parseFloat(r.total||0).toFixed(2)}</td>
                    <td class="status">${r.status || 'Pendente'}</td>
                    <td>${hora}</td>
                    <td><a href="#" class="view-order"><i class="fas fa-chevron-right"></i></a></td>`;
                orderTbody.appendChild(tr);
            });
            // Aplica cores aos status
            orderTbody.querySelectorAll('td.status').forEach(td=>{
                applyStatusColor(td, td.textContent.trim());
            });
            filterOrders();
        }
        // Chamada inicial e polling a cada 15s
        fetchOrders();
        setInterval(fetchOrders, 15000);

        // ----- Mapeamento de status para cores -----
        const statusColors = {
            'Pendente': '#f1c40f',      // amarelo
            'Confirmado': '#3498db',    // azul
            'Preparando': '#555555',    // cinza/preto
            'Pronto': '#3498db',        // azul
            'Entregue': '#4CAF50',      // verde
            'Cancelado': '#e74c3c'      // vermelho
        };

        // Aplica a cor apropriada a um elemento conforme o status
        function applyStatusColor(element, statusText){
            const color = statusColors[statusText] || '#333333';
            // Evita colorir o <select> (lista); aplicamos cor só em células da tabela
            if(element.tagName !== 'SELECT'){
                element.style.color = color;
            } else {
                // remove qualquer cor inline caso tenha sido aplicada antes
                element.style.color = '';
            }
        }

        // Colore todos os status existentes na tabela ao carregar a página
        orderTbody.querySelectorAll('td.status').forEach(td=>{
            applyStatusColor(td, td.textContent.trim());
        });

        // Inicializa a cor do <select> de status
        applyStatusColor(orderStatusSelect, orderStatusSelect.value);

        // Atualiza a cor do <select> quando o usuário muda a opção
        orderStatusSelect.addEventListener('change', ()=>{
            applyStatusColor(orderStatusSelect, orderStatusSelect.value);
        });

        orderTbody.addEventListener('click', function(e){
            const view = e.target.closest('.view-order');
            if(view){
                e.preventDefault();
                currentOrderRow = view.closest('tr');
                const cells = currentOrderRow.cells;
                orderInfo.innerHTML = `
                    <strong>Nº:</strong> ${cells[0].textContent}<br>
                    <strong>Cliente:</strong> ${cells[1].textContent}<br>
                    <strong>Telefone:</strong> ${currentOrderRow.dataset.phone || '-'}<br>
                    <strong>Itens:</strong> ${cells[2].textContent}<br>
                    <strong>Total:</strong> ${cells[3].textContent}<br>
                    <strong>Endereço:</strong> ${currentOrderRow.dataset.entrega}<br>
                    <strong>Data da emição do Pedido:</strong> ${currentOrderRow.dataset.pedido}<br>
                    <strong>Data de entrega:</strong> ${currentOrderRow.dataset.pronto}<br>
                    <strong>Horário:</strong> ${cells[5].textContent}
                `;
                orderStatusSelect.value = cells[4].textContent.trim();
                orderModal.classList.add('open');
            }
        });

        closeOrderModalBtn.addEventListener('click', ()=> orderModal.classList.remove('open'));

        // ---- Função de filtragem ----
        function filterOrders(){
            const d   = filterDate.value;
            const st  = filterStatus.value.toLowerCase();
            const pMin= parseFloat(priceMin.value||'0');
            const pMax= parseFloat(priceMax.value||'0');
            const cli = filterClient.value.toLowerCase();
            const ord = filterOrder.value.replace('#','').toLowerCase();

            orderTbody.querySelectorAll('tr').forEach(row=>{
                const cells = row.cells;
                if(!cells.length) return;

                const rowDate  = row.dataset.pedido || '';
                const rowStatus= cells[4].textContent.toLowerCase();
                const totalStr = cells[3].textContent.replace(/[R$\s.]/g,'').replace(',','.');
                const totalVal = parseFloat(totalStr)||0;
                const client   = cells[1].textContent.toLowerCase();
                const orderNum = cells[0].textContent.replace('#','').toLowerCase();

                let visible = true;
                if(d && rowDate!==d) visible=false;
                if(st && !rowStatus.includes(st)) visible=false;
                if(pMin && totalVal < pMin) visible=false;
                if(pMax && totalVal > pMax) visible=false;
                if(cli && !client.includes(cli)) visible=false;
                if(ord && !orderNum.includes(ord)) visible=false;

                row.style.display = visible?'' : 'none';
            });
        }

        // Eventos de filtro
        [filterDate,filterStatus,priceMin,priceMax,filterClient,filterOrder].forEach(el=>{
            if(el) el.addEventListener('input', filterOrders);
        });
        if(clearFilter){
            clearFilter.addEventListener('click', ()=>{
                filterDate.value='';filterStatus.value='';priceMin.value='';priceMax.value='';filterClient.value='';filterOrder.value='';
                filterOrders();
            });
        }

        // Executa filtro inicial
        filterOrders();

        saveOrderBtn.addEventListener('click', ()=>{
            if(currentOrderRow){
                const newStatus = orderStatusSelect.value;
                const statusCell = currentOrderRow.cells[4];
                statusCell.textContent = newStatus;
                applyStatusColor(statusCell, newStatus);
                // persiste no servidor
                const id = currentOrderRow.cells[0].textContent.replace('#','');
                fetch(`/api/pedido/${id}/status`,{
                    method:'PUT',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({status:newStatus})
                }).then(res=>{
                    if(!res.ok){alert('Falha ao salvar status');}
                });
            }
            orderModal.classList.remove('open');
        });
    </script>
</body>
</html>